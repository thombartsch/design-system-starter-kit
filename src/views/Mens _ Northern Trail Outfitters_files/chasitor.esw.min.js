window.esw.defineFeature("Chasitor",function(y){var v=/get[A-Z][A-Za-z0-9_]*/;var l=[".soma.salesforce.com",".salesforceliveagent.com",".internal.salesforce.com",".eng.sfdc.net",".gus.salesforce.com"];function p(){this.esw=y;this.liveAgentChasitor=undefined;this.events=undefined;this.chasitorSettings=undefined;this.prechatFormDetails=undefined;this.prechatEntities=undefined;this.chatWindowStateName=undefined;this.chatKey=undefined;this.registerMessageHandlers();if(y.getSafariType()!=="mobile"){this.registerBroadcastHandlers();}y.loadFeatureScript("FileTransfer");}function c(T){var U="";if(T&&typeof T==="string"){return T;}else{if(T.type==="ChatWindowButton"){U+="Button Selections:";}else{if(T.type==="ChatWindowMenu"){U+="Menu Options:";}}if(T.items){T.items.forEach(function(V){U+="\n\t"+V.text;});}}return U;}p.prototype.sendBroadcastEventToSlaveTabs=function D(T,U){var V=U||{};if(!V.domain){V.domain=this.domain;}if(!V.chatKey){V.chatKey=this.chatKey;}y.broadcastAPI.send(T,V);};p.prototype.getChatKeyFromSessionStorage=function w(U){var T=JSON.parse(y.sessionAPI.getSessionData(U,["CHASITOR_SERIALIZED_KEY"]).CHASITOR_SERIALIZED_KEY);if(T&&T.chasitorData){return T.chasitorData.chatKey;}return undefined;};p.prototype.isChatKeyValid=function m(T){if(!T){console.log("Chat key was not defined on receiving broadcast event.");}return this.chatKey===T;};p.prototype.registerMessageHandlers=function r(){y.addMessageHandler("chasitor.load",this.loadChasitor.bind(this));y.addMessageHandler("chasitor.sendMessage",function(U,T){this.sendMessage(T);}.bind(this));y.addMessageHandler("chasitor.sendRichMessage",function(U,T){this.sendRichMessage(T);}.bind(this));y.addMessageHandler("chasitor.cancelChat",function(){this.cancelChat();}.bind(this));y.addMessageHandler("chasitor.endChat",function(){this.endChat();}.bind(this));y.addMessageHandler("chasitor.abortConnection",function(){this.abortConnection();}.bind(this));y.addMessageHandler("chasitor.sendSneakPeekOrTypingUpdate",function(U,T){this.sendSneakPeekOrTypingUpdate(T);}.bind(this));y.addMessageHandler("chasitor.saveChat",function(){this.saveChat();}.bind(this));y.addMessageHandler("chasitor.updateChatWindowState",function(U,T){this.updateChatWindowState(T);}.bind(this));y.addMessageHandler("chasitor.removeEventListeners",function(){this.removeEventListeners();}.bind(this));y.addMessageHandler("chasitor.stopChasitorIdleTimeout",function(){this.stopChasitorIdleTimeout();}.bind(this));y.addMessageHandler("chasitor.sendCustomEvent",function(U,T){this.sendCustomEvent(U,T);}.bind(this));y.addMessageHandler("chasitor.getCustomEvents",function(){this.getCustomEvents();}.bind(this));y.addMessageHandler("chasitor.addCustomEventListener",function(U,T){this.addCustomEventListener(U,T);}.bind(this));y.addMessageHandler("chasitor.decrementActiveChatSession",function(U,T){this.decrementActiveChatSession(U,T);}.bind(this));};p.prototype.registerBroadcastHandlers=function x(){y.broadcastAPI.on("incrementActiveChatSession",function(T){if(this.liveAgentChasitor&&this.isChatKeyValid(T.chatKey)){this.incrementActiveChatSession();}}.bind(this));y.broadcastAPI.on("decrementActiveChatSession",function(T){if(this.liveAgentChasitor&&this.isChatKeyValid(T.chatKey)){this.decrementActiveChatSession();}}.bind(this));y.broadcastAPI.on("liveAgentChasitorEvent",function(U){var T=y.sessionAPI.getSessionData(this.domain,["MASTER_DEPLOYMENT_ID"]).MASTER_DEPLOYMENT_ID===this.chasitorSettings.deploymentId;if(this.isChatKeyValid(U.chatKey)&&!T){parent.postMessage({method:"liveagent.event",data:U},y.parentOrigin);}}.bind(this));y.broadcastAPI.on("gatherChasitorSessionData",function(T){if(this.liveAgentChasitor){this.gatherChasitorSessionData(T);}}.bind(this));y.broadcastAPI.on("sendMessage",function(T){if(this.liveAgentChasitor&&this.isChatKeyValid(T.chatKey)){this.sendMessage(T.message);}}.bind(this));y.broadcastAPI.on("sendRichMessage",function(T){if(this.liveAgentChasitor&&this.isChatKeyValid(T.chatKey)){this.sendRichMessage(T.message);}}.bind(this));y.broadcastAPI.on("serializeChat",function(T){if(this.liveAgentChasitor&&this.isChatKeyValid(T.chatKey)){this.serializeChat();}}.bind(this));y.broadcastAPI.on("cancelChat",function(T){if(this.isChatKeyValid(T.chatKey)){parent.postMessage({method:"liveagent.chatCanceledOnDifferentTab"},y.parentOrigin);if(this.liveAgentChasitor){this.cancelChat();}}}.bind(this));y.broadcastAPI.on("endChat",function(T){if(this.liveAgentChasitor&&this.isChatKeyValid(T.chatKey)){this.endChat();}}.bind(this));y.broadcastAPI.on("abortConnection",function(T){if(this.liveAgentChasitor&&this.isChatKeyValid(T.chatKey)){this.abortConnection();}}.bind(this));y.broadcastAPI.on("sendSneakPeekOrTypingUpdate",function(T){if(this.liveAgentChasitor&&this.isChatKeyValid(T.chatKey)){this.sendSneakPeekOrTypingUpdate(T.message);}}.bind(this));y.broadcastAPI.on("saveChat",function(T){if(this.liveAgentChasitor&&this.isChatKeyValid(T.chatKey)){this.saveChat();}}.bind(this));y.broadcastAPI.on("removeEventListeners",function(T){if(this.liveAgentChasitor&&this.isChatKeyValid(T.chatKey)){this.removeEventListeners();}}.bind(this));y.broadcastAPI.on("stopChasitorIdleTimeout",function(T){if(this.liveAgentChasitor&&this.isChatKeyValid(T.chatKey)){this.stopChasitorIdleTimeout();}}.bind(this));};p.prototype.setChasitorData=function q(U,T){this.domain=U;this.chasitorSettings=T.settingsObj;this.hasOnlyExtraPrechatInfo=T.hasOnlyExtraPrechatInfo;this.prechatFormDetails=T.prechatFormDetails;this.prechatEntities=T.prechatEntities;};p.prototype.createScriptElement=function C(){var T=document.createElement("script");T.id="chasitorScript";T.type="text/javascript";T.onload=function(){this.chasitorInit();}.bind(this);T.src=this.chasitorSettings.chasitorSrc;document.getElementsByTagName("head")[0].appendChild(T);};p.prototype.serializeChat=function B(){var T;var U;if(this.liveAgentChasitor&&!this.liveAgentChasitor.isChatEnded()&&(this.liveAgentChasitor.isChatRequestSuccessful()||this.liveAgentChasitor.isChatEngaged())){T=this.liveAgentChasitor.serialize();U=JSON.parse(T);U.chasitorData.isChatEstablished=this.chatWindowStateName==="Chat";y.sessionAPI.setSessionData(this.domain,{CHASITOR_SERIALIZED_KEY:JSON.stringify(U)});}};p.prototype.handleLiveAgentChasitorEvent=function H(V,W){var T=W;var U;var X=["chasitorAgentChatEnded","chasitorAgentDisconnected","chasitorChasitorChatCanceled","chasitorChatRequestFailed","chasitorConnectionError"];if(X.indexOf(V)>=0){this.esw.sessionAPI.deleteSessionData(this.domain,["MASTER_DEPLOYMENT_ID"]);this.removeActiveChatSession(this.domain,this.chasitorSettings.deploymentId);}if(V===this.liveAgentChasitor.Events.CHAT_REQUEST_SUCCESSFUL){this.chatKey=this.liveAgentChasitor.getChatKey();}if(typeof W==="object"){T={};Object.getOwnPropertyNames(W).forEach(function(Y){if(typeof W[Y]==="function"&&v.test(Y)){T[Y]=W[Y]();}else{T[Y]=W[Y];}});}else{T=W;}U={event:V,params:T,chasitorData:this.gatherChasitorSessionData()};if(V!=="chasitorChatRequestSuccessful"){this.sendBroadcastEventToSlaveTabs("liveAgentChasitorEvent",U);}parent.postMessage({method:"liveagent.event",data:U},y.parentOrigin);};p.prototype.registerEvents=function L(){if(this.events){Object.keys(this.events).forEach(function(T){var U=this.events[T];this.liveAgentChasitor.addEventListener(U,this.handleLiveAgentChasitorEvent.bind(this,U),"ESW_"+U);}.bind(this));}};p.prototype.passPrechatDataToLiveAgent=function A(){if(this.prechatFormDetails===undefined||!this.prechatFormDetails.length){return;}this.prechatFormDetails.forEach(function(V){var W=V.value;var T=V.transcriptFields;var U;if(typeof W==="string"){W=V.value.trim();}U=this.liveAgentChasitor.addCustomDetail(V.label,W,V.displayToAgent);if(T){T.forEach(U.addTranscriptField);}if(V.name==="FirstName"){this.liveAgentChasitor.setName(W);this.liveAgentChasitor.setLocalName(W);}}.bind(this));this.liveAgentChasitor.addCustomDetail("eswLiveAgentDevName",this.chasitorSettings.eswLiveAgentDevName,false);this.liveAgentChasitor.addCustomDetail("hasOnlyExtraPrechatInfo",this.hasOnlyExtraPrechatInfo,false);this.prechatEntities.forEach(function(U){var T;this.liveAgentChasitor.addEntity(U.entityName,U.showOnCreate,U.linkToEntityName,U.linkToEntityField,U.saveToTranscript);T=U.entityFieldMaps;T.forEach(function(V){this.liveAgentChasitor.addEntityFieldsMap(U.entityName,V.fieldName,V.label,V.doFind,V.isExactMatch,V.doCreate);}.bind(this));}.bind(this));};p.prototype.passCustomDetailsToLiveAgent=function u(){if(this.chasitorSettings.hasOwnProperty("chatbotVersion")&&this.chasitorSettings.chatbotVersion){this.liveAgentChasitor.addCustomDetail("chatbotVersion",this.chasitorSettings.chatbotVersion,false);}};p.prototype.isNewChatSession=function M(){return !y.sessionAPI.getSessionData(this.domain,["CHASITOR_SERIALIZED_KEY"]).CHASITOR_SERIALIZED_KEY;};p.prototype.gatherChasitorSessionData=function z(U){var T={chasitorSettings:this.chasitorSettings,acceptTime:this.liveAgentChasitor.getAcceptTime(),requestTime:this.liveAgentChasitor.getRequestTime(),oref:this.liveAgentChasitor.getOref(),chatKey:this.liveAgentChasitor.getChatKey(),connectionSessionId:this.liveAgentChasitor.getConnectionSessionId(),details:this.liveAgentChasitor.getDetails(),name:this.liveAgentChasitor.getName(),chatMessages:this.getChatMessages(),isSneakPeekEnabled:this.liveAgentChasitor.isSneakPeekEnabled(),isAgentTyping:this.liveAgentChasitor.isAgentTyping(),isFileRequested:this.liveAgentChasitor.isFileRequested(),isChatEstablished:this.liveAgentChasitor.isChatEstablished(),isChatEngaged:this.liveAgentChasitor.isChatEngaged(),isChatEnded:this.liveAgentChasitor.isChatEnded(),isChatTransferredToQueue:this.liveAgentChasitor.isChatTransferredToQueue(),isChatRequestSuccessful:this.liveAgentChasitor.isChatRequestSuccessful(),queuePosition:this.liveAgentChasitor.getQueuePosition(),orgId:this.liveAgentChasitor.getOrgId(),language:this.liveAgentChasitor.getLanguage(),lastUrl:this.liveAgentChasitor.getLastUrl(),transcriptSaveEnabled:this.liveAgentChasitor.getTranscriptSaveEnabled()};if(U){T.isSnapinsSlaveTab=true;this.sendBroadcastEventToSlaveTabs("chasitorSessionDataRefreshed",T);}return T;};p.prototype.getChatMessages=function S(){var T=this.liveAgentChasitor.getChatMessages();var U=[];T.forEach(function(V){var W={};Object.getOwnPropertyNames(V).forEach(function(X){if(typeof V[X]==="function"&&v.test(X)){W[X]=V[X]();}});U.push(W);});return U;};p.prototype.initializeChasitor=function Q(){var V="snapins";var T=this.chasitorSettings.endpointURL;var W=this.chasitorSettings.contentServerURL;var U=this.chasitorSettings.visitorInfo;this.liveAgentChasitor.resetChasitorState();this.liveAgentChasitor.setOrgId(this.chasitorSettings.orgId);this.liveAgentChasitor.setDeploymentId(this.chasitorSettings.deploymentId);this.liveAgentChasitor.setButtonId(this.chasitorSettings.buttonId);this.passPrechatDataToLiveAgent();this.passCustomDetailsToLiveAgent();this.liveAgentChasitor.setReceiveQueueUpdates(this.chasitorSettings.isQueuePositionEnabled||false);this.liveAgentChasitor.setVisitorInfo(U.visitCount,U.originalReferrer,U.pages);this.liveAgentChasitor.init(T,W,this.chasitorSettings.fallbackRouting,false);this.liveAgentChasitor.startChat(V);parent.postMessage({method:"liveagent.initialized",data:{chasitorEvents:this.events,chasitorSessionData:this.gatherChasitorSessionData()}},y.parentOrigin);};p.prototype.restoreSession=function F(){var U;var T=false;if(this.liveAgentChasitor){this.liveAgentChasitor.deserialize(y.sessionAPI.getSessionData(this.domain,["CHASITOR_SERIALIZED_KEY"]).CHASITOR_SERIALIZED_KEY);this.liveAgentChasitor.setReceiveQueueUpdates(this.chasitorSettings.isQueuePositionEnabled);this.liveAgentChasitor.init(this.chasitorSettings.endpointURL,this.chasitorSettings.contentServerURL,this.chasitorSettings.fallbackRouting,false);this.liveAgentChasitor.reinitializeSession();this.liveAgentChasitor.restoreChasitorIdleTimeout();this.chatKey=this.liveAgentChasitor.getChatKey();parent.postMessage({method:"liveagent.restored",data:{chasitorEvents:this.events,chasitorSessionData:this.gatherChasitorSessionData()}},y.parentOrigin);}else{U=JSON.parse(y.sessionAPI.getSessionData(this.domain,["CHASITOR_EVENTS"]).CHASITOR_EVENTS);this.chatKey=this.getChatKeyFromSessionStorage(this.domain);y.broadcastAPI.on("chasitorSessionDataRefreshed",function(V){if(!T){parent.postMessage({method:"liveagent.restored",data:{chasitorEvents:U,chasitorSessionData:V}},y.parentOrigin);T=true;}});y.broadcastAPI.send("gatherChasitorSessionData","slaveTabRestore");}};p.prototype.chasitorInit=function i(){this.liveAgentChasitor=window.liveagent.chasitor;Object.defineProperty(this,"events",{get:function(){return this.liveAgentChasitor.Events;}.bind(this)});y.sessionAPI.setSessionData(this.domain,{CHASITOR_EVENTS:JSON.stringify(this.liveAgentChasitor.Events)});this.registerEvents();this.liveAgentChasitor.onMutate=function(){this.serializeChat();}.bind(this);this.startChatSession();};p.prototype.startChatSession=function t(){if(this.isNewChatSession()){this.initializeChasitor();}else{this.restoreSession();}};p.prototype.sendMessage=function b(T){var U={};if(this.liveAgentChasitor){this.liveAgentChasitor.sendMessage(T);}else{if(!document.hidden){U.message=T;this.sendBroadcastEventToSlaveTabs("sendMessage",U);}}};p.prototype.sendRichMessage=function d(T){var U={};if(this.liveAgentChasitor){this.liveAgentChasitor.sendSnapInRichMessage(T);}else{if(!document.hidden){U.message=T;this.sendBroadcastEventToSlaveTabs("sendRichMessage",U);}}};p.prototype.cancelChat=function P(){if(this.liveAgentChasitor){this.liveAgentChasitor.cancelChat();this.esw.sessionAPI.deleteSessionData(this.domain,["CHASITOR_SERIALIZED_KEY","MASTER_DEPLOYMENT_ID"]);this.removeActiveChatSession(this.domain,this.chasitorSettings.deploymentId);}this.sendBroadcastEventToSlaveTabs("cancelChat");};p.prototype.endChat=function k(){if(this.liveAgentChasitor){this.liveAgentChasitor.endChat();this.esw.sessionAPI.deleteSessionData(this.domain,["CHASITOR_SERIALIZED_KEY","MASTER_DEPLOYMENT_ID"]);this.removeActiveChatSession(this.domain,this.chasitorSettings.deploymentId);}else{this.sendBroadcastEventToSlaveTabs("endChat");}};p.prototype.removeActiveChatSession=function j(V,T){var U=JSON.parse(y.sessionAPI.getSessionData(V,["ACTIVE_CHAT_SESSIONS"],true).ACTIVE_CHAT_SESSIONS||"{}");delete U[T];y.sessionAPI.setSessionData(V,{ACTIVE_CHAT_SESSIONS:JSON.stringify(U)},true);this.updateMaster(false,0);};p.prototype.incrementActiveChatSession=function E(){var U;var T=this.chasitorSettings.deploymentId;if(this.liveAgentChasitor){U=JSON.parse(y.sessionAPI.getSessionData(this.domain,["ACTIVE_CHAT_SESSIONS"],true).ACTIVE_CHAT_SESSIONS||"{}");if(!U[T]){U[T]=0;}U[T]+=1;y.sessionAPI.setSessionData(this.domain,{ACTIVE_CHAT_SESSIONS:JSON.stringify(U)},true);this.updateMaster(true,U[T]);}else{this.sendBroadcastEventToSlaveTabs("incrementActiveChatSession");}};p.prototype.decrementActiveChatSession=function I(){var U;var T=this.chasitorSettings.deploymentId;if(this.liveAgentChasitor){U=JSON.parse(y.sessionAPI.getSessionData(this.domain,["ACTIVE_CHAT_SESSIONS"],true).ACTIVE_CHAT_SESSIONS||"{}");if(U[T]){U[T]-=1;}else{y.log("Decrement active chat sessions : Local Storage item ACTIVE_CHAT_SESSIONS not found for deployment id :"+T);}y.sessionAPI.setSessionData(this.domain,{ACTIVE_CHAT_SESSIONS:JSON.stringify(U)},true);this.updateMaster(true,U[T]);}else{this.sendBroadcastEventToSlaveTabs("decrementActiveChatSession");}};p.prototype.updateMaster=function h(U,T){var V={};V.isMaster=U;V.activeChatSessions=T;y.postMessage("session.updateMaster",V);};p.prototype.loadChasitor=function K(Z,Y){var U=y.sessionAPI.getSessionData(Z,["CHASITOR_SERIALIZED_KEY"]).CHASITOR_SERIALIZED_KEY;var T=Y.settingsObj.deploymentId;var W=y.sessionAPI.getSessionData(Z,["MASTER_DEPLOYMENT_ID"]).MASTER_DEPLOYMENT_ID===T;var V=JSON.parse(y.sessionAPI.getSessionData(Z,["ACTIVE_CHAT_SESSIONS"],true).ACTIVE_CHAT_SESSIONS||"{}");var X=document.getElementById("chasitorScript");this.setChasitorData(Z,Y);if(!W&&U&&V[T]){this.restoreSession();this.incrementActiveChatSession();}else{if(X){X.parentNode.removeChild(X);[].slice.apply(document.querySelectorAll("iframe")).forEach(function(ab){var aa=ab.getAttribute("src");if(aa&&aa.indexOf("cdm")!==-1){ab.parentNode.removeChild(ab);}});this.removeEventListeners();}this.verifyScriptHost(this.chasitorSettings.chasitorSrc);this.createScriptElement();y.sessionAPI.setSessionData(Z,{MASTER_DEPLOYMENT_ID:T});if(y.getSafariType()!=="mobile"){V[T]=1;y.sessionAPI.setSessionData(Z,{ACTIVE_CHAT_SESSIONS:JSON.stringify(V)},true);}this.updateMaster(true,1);}};p.prototype.verifyScriptHost=function o(U,V){var T;if(window.URL&&typeof window.URL==="function"){T=new URL(U).hostname;}else{if(U.indexOf("//")>-1){T=U.split("/")[2];}else{T=U.split("/")[0];}T=T.split(":")[0];T=T.split("?")[0];}if(!this.isValidHostname(T)){throw new Error(V||"Chasitor script served from invalid host! Chasitor script must come from one of the following domains: "+l.join(", "));}};p.prototype.isValidHostname=function a(T){return l.some(function(U){return T.indexOf(U,T.length-U.length)>0;});};p.prototype.sendSneakPeekOrTypingUpdate=function g(T){var U={};if(this.liveAgentChasitor){if(this.liveAgentChasitor.isSneakPeekEnabled()){this.liveAgentChasitor.sendSneakPeek(T);}else{this.liveAgentChasitor.sendTypingUpdate(T.length);}}else{U.message=T;this.sendBroadcastEventToSlaveTabs("sendSneakPeekOrTypingUpdate",U);}};p.prototype.saveChat=function e(){var W="";var V=[];var T=[];var U=[];if(this.liveAgentChasitor){if(/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream){this.liveAgentChasitor.getChatMessages().forEach(function(X){var Y=X.getContent();if(typeof Y!=="string"){Y=c(Y);}if(Y){V.push(X.getName());T.push(X.getTimestamp());U.push(Y);}});W=JSON.stringify({names:V,timestamps:T,messages:U});y.postMessage("liveagent.saveChatIOSCallback",{chasitorData:this.gatherChasitorSessionData(),textLog:W});}else{this.liveAgentChasitor.saveChat();}}else{if(!document.hidden){this.sendBroadcastEventToSlaveTabs("saveChat");}}};p.prototype.abortConnection=function R(){if(this.liveAgentChasitor){this.liveAgentChasitor.abortConnection();this.serializeChat();}else{this.sendBroadcastEventToSlaveTabs("abortConnection");}};p.prototype.serialize=function f(){this.liveAgentChasitor.serialize();};p.prototype.sendCustomEvent=function O(U,T){this.liveAgentChasitor.sendCustomEvent(T.type,T.data);};p.prototype.getCustomEvents=function s(){var T=this.liveAgentChasitor.getCustomEvents();var U=T.map(function(W){return{source:W.getSource(),type:W.getType(),data:W.getData(),date:W.getDate()};});var V=JSON.stringify(U);parent.postMessage({method:"liveagent.getCustomEventsResult",data:{customEvents:V}},y.parentOrigin);};p.prototype.addCustomEventListener=function n(V,T){var U=function(W){parent.postMessage({method:"liveagent.customEventReceived",data:{type:W.getType(),data:W.getData()}},y.parentOrigin);};this.liveAgentChasitor.addCustomEventListener(T,U);};p.prototype.removeEventListeners=function J(){if(this.liveAgentChasitor){window.liveagent.removeEventListeners();}else{this.sendBroadcastEventToSlaveTabs("removeEventListeners");}};p.prototype.updateChatWindowState=function N(T){this.chatWindowStateName=T;if(this.liveAgentChasitor){this.serializeChat();}else{this.sendBroadcastEventToSlaveTabs("serializeChat");}};p.prototype.stopChasitorIdleTimeout=function G(){if(this.liveAgentChasitor){this.liveAgentChasitor.stopChasitorIdleTimeout();}else{this.sendBroadcastEventToSlaveTabs("stopChasitorIdleTimeout");}};y.chasitorAPI=new p();});